{% extends "base.html" %}
{% block title %}Water Quality Dashboard{% endblock %}

{% block content %}

<header class="text-left mb-6">
    <h2 class="text-3xl font-bold text-gray-900">Real-Time Water Quality</h2>
    <p class="text-md text-gray-600 mt-1">Live sensor data and analysis from IoT modules</p>
</header>

<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-6">
    
    <div class="card flex flex-col justify-between text-center">
        <div>
            <div class="flex items-center justify-center text-blue-500 mb-4">
                <svg class="w-12 h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-700">Temperature</h2>
            <p id="tempValue" class="text-5xl font-bold my-2">--.- °C</p>
        </div>
        <div class="mt-4">
            <p id="tempStatus" class="text-gray-500 text-sm h-5">Connecting...</p>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2">
                <div id="tempGauge" class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="card flex flex-col justify-between text-center">
        <div>
            <div class="flex items-center justify-center text-purple-500 mb-4">
                 <svg class="w-12 h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v5"/><path d="M12 17v5"/><path d="M5.12 7.12 8.6 10.6"/><path d="M15.4 13.4 18.88 16.88"/><path d="M7.12 18.88 10.6 15.4"/><path d="M13.4 8.6 16.88 5.12"/></svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-700">pH Level</h2>
            <p id="phValue" class="text-5xl font-bold my-2">--.-</p>
        </div>
        <div class="mt-4">
            <p id="phStatus" class="text-gray-500 text-sm h-5">Waiting for data...</p>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2">
                <div id="phGauge" class="bg-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="card flex flex-col justify-between text-center">
        <div>
            <div class="flex items-center justify-center text-green-500 mb-4">
                <svg class="w-12 h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 14 4-4"/><path d="m16 14-4-4"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M7 7l4-4 4 4"/><path d="M7 17l4 4 4-4"/></svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-700">TDS</h2>
            <p id="tdsValue" class="text-5xl font-bold my-2">---</p>
        </div>
        <div class="mt-4">
             <p id="tdsStatus" class="text-gray-500 text-sm h-5">Total Dissolved Solids</p>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2">
                <div id="tdsGauge" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="card flex flex-col justify-between text-center">
         <div>
            <div class="flex items-center justify-center text-yellow-500 mb-4">
                <svg class="w-12 h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h3"/><path d="M19 12h3"/><path d="M12 2v3"/><path d="M12 19v3"/><circle cx="12" cy="12" r="2"/><path d="M4.93 4.93 7 7"/><path d="M17 17l2.07 2.07"/><path d="m17 7-2.07-2.07"/><path d="M7 17l-2.07 2.07"/></svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-700">Turbidity</h2>
            <p id="turbidityValue" class="text-5xl font-bold my-2">--.-</p>
        </div>
        <div class="mt-4">
            <p id="turbidityStatus" class="text-gray-500 text-sm h-5">Water Clarity</p>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2">
                <div id="turbidityGauge" class="bg-yellow-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="card flex flex-col justify-between text-center">
         <div>
            <div class="flex items-center justify-center text-teal-500 mb-4">
                <svg class="w-12 h-12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 0-10 10c0 3.31 1.67 6.22 4.2 8M12 22a10 10 0 0 0 10-10M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10m0-20a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"/></svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-700">BOD</h2>
            <p id="bodValue" class="text-5xl font-bold my-2">--.-</p>
        </div>
        <div class="mt-4">
            <p id="bodStatus" class="text-gray-500 text-sm h-5">Biochemical O₂ Demand</p>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2">
                <div id="bodGauge" class="bg-teal-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="card flex flex-col justify-between text-center">
         <div>
            <div class="flex items-center justify-center text-slate-500 mb-4">
                <svg class="w-12 h-12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7.5c0 .96-.04 1.9-.12 2.82a1.5 1.5 0 0 1-1.46 1.46c-.92.08-1.86.12-2.82.12-1.9 0-3.7-.2-5.4-.58"/><path d="M3 16.5c0-.96.04-1.9.12-2.82a1.5 1.5 0 0 1 1.46-1.46C5.5 12.14 6.44 12.1 7.4 12.1c1.9 0 3.7.2 5.4.58"/><path d="M21 16.5c0-.96-.04-1.9-.12-2.82a1.5 1.5 0 0 0-1.46-1.46c-.92-.08-1.86-.12-2.82-.12-1.9 0-3.7.2-5.4.58"/><path d="M3 7.5c0 .96.04 1.9.12 2.82A1.5 1.5 0 0 0 4.58 11.8c.92.08 1.86.12 2.82.12 1.9 0 3.7-.2 5.4-.58"/></svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-700">COD</h2>
            <p id="codValue" class="text-5xl font-bold my-2">--.-</p>
        </div>
        <div class="mt-4">
            <p id="codStatus" class="text-gray-500 text-sm h-5">Chemical O₂ Demand</p>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2">
                <div id="codGauge" class="bg-slate-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="card text-center flex flex-col justify-center items-center">
         <h2 class="text-xl font-semibold text-gray-700 mb-3">Overall Water Quality</h2>
         <div id="overallStatusIcon" class="mb-3">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
         </div>
         <p id="overallStatusText" class="text-3xl font-bold text-gray-500">Calculating...</p>
    </div>

    <div class="card">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Insights & Recommendations</h2>
        <ul id="recommendationsList" class="space-y-3 text-gray-700">
            <li class="flex items-start"><span class="mr-2">-</span><span>Loading insights...</span></li>
        </ul>
    </div>
</div>

<footer class="text-center mt-8 text-gray-500"><p>Last updated: <span id="lastUpdated">Never</span></p></footer>


<script>
    // NO CHANGES ARE NEEDED FOR THE JAVASCRIPT
    // It will work perfectly with the new HTML layout.

    document.addEventListener('DOMContentLoaded', () => {
        const elements = {
            temp: { val: document.getElementById('tempValue'), status: document.getElementById('tempStatus'), gauge: document.getElementById('tempGauge') },
            ph: { val: document.getElementById('phValue'), status: document.getElementById('phStatus'), gauge: document.getElementById('phGauge') },
            tds: { val: document.getElementById('tdsValue'), status: document.getElementById('tdsStatus'), gauge: document.getElementById('tdsGauge') },
            turbidity: { val: document.getElementById('turbidityValue'), status: document.getElementById('turbidityStatus'), gauge: document.getElementById('turbidityGauge') },
            bod: { val: document.getElementById('bodValue'), status: document.getElementById('bodStatus'), gauge: document.getElementById('bodGauge') },
            cod: { val: document.getElementById('codValue'), status: document.getElementById('codStatus'), gauge: document.getElementById('codGauge') },
            overall: { text: document.getElementById('overallStatusText'), icon: document.getElementById('overallStatusIcon') },
            recommendations: document.getElementById('recommendationsList'),
            lastUpdated: document.getElementById('lastUpdated')
        };

        const icons = {
            good: `<svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            warning: `<svg class="w-12 h-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`,
            danger: `<svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
        };

        const fetchData = async () => {
            try {
                const response = await fetch('/get_data');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error("Could not fetch data:", error);
            }
        };

        setInterval(fetchData, 3000);
        fetchData();

        function updateDashboard(data) {
            elements.temp.val.innerHTML = `${data.temperature.toFixed(1)} °C`;
            elements.ph.val.textContent = data.ph.toFixed(1);
            elements.tds.val.innerHTML = `${data.tds.toFixed(0)} <span class="text-xl">ppm</span>`;
            elements.turbidity.val.innerHTML = `${data.turbidity.toFixed(1)} <span class="text-xl">NTU</span>`;
            elements.bod.val.innerHTML = `${data.bod.toFixed(0)} <span class="text-xl">mg/L</span>`;
            elements.cod.val.innerHTML = `${data.cod.toFixed(0)} <span class="text-xl">mg/L</span>`;
            elements.lastUpdated.textContent = new Date(data.timestamp * 1000).toLocaleTimeString();

            const ranges = {
                temp: { good: [18, 28], warn: [15, 31], scale: [0, 40] },
                ph: { good: [6.8, 8.2], warn: [6.5, 8.5], scale: [0, 14] },
                tds: { good: [150, 500], warn: [50, 800], scale: [0, 1000] },
                turbidity: { good: [0, 5], warn: [5, 10], scale: [0, 20] },
                bod: { good: [0, 5], warn: [5, 8], scale: [0, 20] },
                cod: { good: [0, 20], warn: [20, 40], scale: [0, 100] }
            };

            const statuses = {
                temp: getStatus(data.temperature, ranges.temp.good, ranges.temp.warn),
                ph: getStatus(data.ph, ranges.ph.good, ranges.ph.warn),
                tds: getStatus(data.tds, ranges.tds.good, ranges.tds.warn),
                turbidity: getStatus(data.turbidity, ranges.turbidity.good, ranges.turbidity.warn),
                bod: getStatus(data.bod, ranges.bod.good, ranges.bod.warn),
                cod: getStatus(data.cod, ranges.cod.good, ranges.cod.warn)
            };
            
            updateCardUI('temp', data.temperature, statuses.temp, ranges.temp.scale);
            updateCardUI('ph', data.ph, statuses.ph, ranges.ph.scale);
            updateCardUI('tds', data.tds, statuses.tds, ranges.tds.scale);
            updateCardUI('turbidity', data.turbidity, statuses.turbidity, ranges.turbidity.scale);
            updateCardUI('bod', data.bod, statuses.bod, ranges.bod.scale);
            updateCardUI('cod', data.cod, statuses.cod, ranges.cod.scale);
            
            updateSummaryAndRecommendations(statuses, data);
        }

        function updateCardUI(param, value, status, scale) {
            const el = elements[param];
            el.status.textContent = `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`;
            el.gauge.style.width = `${(value / scale[1]) * 100}%`;
            
            const colors = { good: 'blue-500', warning: 'yellow-500', danger: 'red-500' };
            if (param === 'ph') colors.good = 'purple-500';
            if (param === 'tds') colors.good = 'green-500';
            if (param === 'bod') colors.good = 'teal-500';
            if (param === 'cod') colors.good = 'slate-500';
            
            el.gauge.classList.remove('bg-blue-500', 'bg-purple-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500', 'bg-teal-500', 'bg-slate-500');
            el.gauge.classList.add(`bg-${colors[status]}`);
        }

        function updateSummaryAndRecommendations(statuses, data) {
            const statusValues = Object.values(statuses);
            let overallStatus = 'good';
            if (statusValues.includes('danger')) {
                overallStatus = 'danger';
            } else if (statusValues.includes('warning')) {
                overallStatus = 'warning';
            }

            elements.overall.text.textContent = overallStatus.charAt(0).toUpperCase() + overallStatus.slice(1);
            elements.overall.icon.innerHTML = icons[overallStatus];
            elements.overall.text.className = `text-3xl font-bold text-${getColor(overallStatus)}-500`;

            let recommendationsHTML = '';
            if (statuses.bod !== 'good') {
                recommendationsHTML += `<li><strong class="font-semibold">BOD Alert:</strong> High level (${data.bod.toFixed(0)} mg/L) indicates organic pollution.</li>`;
            }
            if (statuses.cod !== 'good') {
                recommendationsHTML += `<li><strong class="font-semibold">COD Alert:</strong> High level (${data.cod.toFixed(0)} mg/L) may indicate chemical pollutants.</li>`;
            }
            if (statuses.ph !== 'good') {
                recommendationsHTML += `<li><strong class="font-semibold">pH Alert:</strong> Level is at ${data.ph.toFixed(1)}. Investigate potential sources of acidity or alkalinity.</li>`;
            }
            if (statuses.turbidity !== 'good') {
                recommendationsHTML += `<li><strong class="font-semibold">Turbidity Alert:</strong> High cloudiness (${data.turbidity.toFixed(1)} NTU). Could indicate runoff or algae.</li>`;
            }
            
            if (recommendationsHTML === '') {
                recommendationsHTML = '<li>All parameters are within the optimal range. Water quality is excellent.</li>';
            }
            elements.recommendations.innerHTML = recommendationsHTML;
        }

        function getStatus(value, goodRange, warnRange) {
            if (value >= goodRange[0] && value <= goodRange[1]) return 'good';
            if (value >= warnRange[0] && value <= warnRange[1]) return 'warning';
            return 'danger';
        }

        function getColor(status) {
            if (status === 'good') return 'green';
            if (status === 'warning') return 'yellow';
            return 'red';
        }
    });
</script>
{% endblock %}